name: Prerelease

on:
  push:
    branches:
      - main

permissions:
  contents: write

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  prerelease:
    name: Prerelease
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "lts/*"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Determine next version and generate notes
        id: version
        run: |
          # Get latest non-pre release tag
          LATEST_TAG=$(git tag -l 'v*' | grep -v '\-pre' | sort -V | tail -1)

          if [ -z "$LATEST_TAG" ]; then
            echo "next=0.1.0" >> $GITHUB_OUTPUT
            echo "No previous tag found" > release-notes.md
            exit 0
          fi

          # Parse version components
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # Get commit hashes and messages since last tag
          COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"%H %s" 2>/dev/null || echo "")

          # Categorize commits
          BREAKING=""
          FEATURES=""
          FIXES=""
          OTHER=""

          while IFS= read -r line; do
            [ -z "$line" ] && continue
            HASH=$(echo "$line" | cut -d' ' -f1)
            MSG=$(echo "$line" | cut -d' ' -f2-)
            SHORT_HASH=${HASH:0:7}

            if echo "$MSG" | grep -qE "^.*!:|BREAKING CHANGE:"; then
              BREAKING="${BREAKING}- ${MSG} (${SHORT_HASH})\n"
            elif echo "$MSG" | grep -qE "^feat(\(.+\))?:"; then
              FEATURES="${FEATURES}- ${MSG} (${SHORT_HASH})\n"
            elif echo "$MSG" | grep -qE "^fix(\(.+\))?:"; then
              FIXES="${FIXES}- ${MSG} (${SHORT_HASH})\n"
            else
              OTHER="${OTHER}- ${MSG} (${SHORT_HASH})\n"
            fi
          done <<< "$COMMITS"

          # Determine bump type based on commits
          if [ -n "$BREAKING" ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [ -n "$FEATURES" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi

          echo "next=${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT

          # Generate release notes
          {
            echo "## What's Changed"
            echo ""
            if [ -n "$BREAKING" ]; then
              echo "### Breaking Changes"
              echo -e "$BREAKING"
            fi
            if [ -n "$FEATURES" ]; then
              echo "### Features"
              echo -e "$FEATURES"
            fi
            if [ -n "$FIXES" ]; then
              echo "### Bug Fixes"
              echo -e "$FIXES"
            fi
            if [ -n "$OTHER" ]; then
              echo "### Other Changes"
              echo -e "$OTHER"
            fi
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${LATEST_TAG}...v${MAJOR}.${MINOR}.${PATCH}-pre"
          } > release-notes.md

      - name: Create or update pre-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEXT_VERSION="${{ steps.version.outputs.next }}"
          TAG="v${NEXT_VERSION}-pre"

          # Delete existing release for this tag if it exists
          if gh release view "$TAG" &>/dev/null; then
            echo "Deleting existing release: $TAG"
            gh release delete "$TAG" --yes || true
          fi

          # Delete the tag if it exists (locally and remotely)
          if git rev-parse "$TAG" &>/dev/null; then
            echo "Deleting existing tag: $TAG"
            git tag -d "$TAG" || true
            git push origin ":refs/tags/$TAG" || true
          fi

          # Create new pre-release with categorized notes
          echo "Creating pre-release: $TAG"
          gh release create "$TAG" \
            --prerelease \
            --notes-file release-notes.md \
            --target main \
            --title "$TAG"
